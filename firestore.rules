rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to validate email format
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    // Helper function to check if request has valid data structure
    function isValidEmailSubscription() {
      let data = request.resource.data;
      return data.keys().hasAll(['email', 'subscribedAt', 'source', 'status']) &&
             isValidEmail(data.email) &&
             data.email is string &&
             data.subscribedAt is timestamp &&
             data.source is string &&
             data.status is string &&
             data.status in ['active', 'unsubscribed'] &&
             data.email.size() <= 254; // Email max length
    }
    
    // Config collection - Public read for specific documents only
    match /config/{documentId} {
      // Allow public read only for specific config documents
      allow read: if documentId in ['downloadlinks', 'contact', 'donation'];
      
      // Only authenticated admin users can write
      allow write: if request.auth != null && 
                     request.auth.token.admin == true;
    }
    
    // Email subscriptions collection
    match /email-updates/{emailId} {
      // Allow reading a specific email document (needed for duplicate checking)
      // This is safe because emailId must match the email in the document
      allow read: if emailId == resource.data.email;
      
      // Allow public write (for email subscriptions) but with validation
      allow create: if isValidEmailSubscription() &&
                      // Prevent duplicate emails by using email as document ID
                      emailId == request.resource.data.email &&
                      // Limit document size
                      request.resource.data.size() <= 500;
      
      // Allow update only if email matches document ID (for re-subscription)
      allow update: if emailId == request.resource.data.email &&
                      isValidEmailSubscription();
      
      // Prevent deletes from public
      allow delete: if false;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
